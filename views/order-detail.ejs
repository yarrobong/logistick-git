<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= order ? `Заказ #${order.id}` : 'Новый Заказ' %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <style>
  /* Темная тема как в Telegram */
body { 
  background-color: #18222D; 
  color: #ffffff; 
}

/* Стили для карточек товаров */
.item-card {
  background-color: #213040; 
  border-radius: .5rem;
  transition: .2s;
  color: white;
  padding: 1rem; /* Внутренний отступ */
}
.item-card:hover { 
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); 
  border-color: #3a3a3a; 
}

/* Стили для редактируемых полей */
.editable-field { 
  cursor: pointer; 
  border-bottom: 1px dashed transparent; 
  display: inline-block; 
  min-width: 80px; /* Зарезервированное место под числа/текст */
  min-height: 1.5em; /* Высота строки */
  padding: 0.125rem 0.25rem; /* Небольшие отступы внутри */
  border-radius: 0.25rem; /* Скругление при наведении */
  
}
.editable-field:hover { 
  border-bottom: 1px dashed #85c1ff; 
  background-color: rgba(133, 193, 255, 0.1); /* Лёгкий фон при наведении */
}

/* Стили для действий с карточкой */
.item-actions { 
  opacity: 0; 
  transition: .2s; 
  display: flex; /* Добавлено */
  align-items: center; /* Выравнивание по центру по вертикали */
  /* Убрано: opacity: 0 на мобильных, если нужно чтобы кнопка была видна всегда */
}
.item-card:hover .item-actions { 
  opacity: 1; 
}

/* Кнопки */
.btn-outline-light {
  border-color: #3a3a3a; 
  color: #d0d0d0; 
  background-color: transparent;
}
.btn-outline-light:hover {
  background-color: #3a3a3a; 
  color: #ffffff; 
}

.btn-success {
  background-color: #0088cc; 
  border-color: #0088cc;
}
.btn-success:hover {
  background-color: #0077b3; 
  border-color: #0077b3;
}

.btn-outline-danger {
  color: #ff3b30; 
  border-color: #ff3b30;
}
.btn-outline-danger:hover {
  background-color: #ff3b30; 
  color: #ffffff; 
}

/* Вводы */
.form-control {
  background-color: #213040; 
  border: none; 
  color: #ffffff; 
  min-width: 80px; /* То же, что и у editable-field */
}
.form-control:focus {
  background-color: #213040;
  color: #ffffff;
  box-shadow: 0 0 0 0.2rem rgba(133, 193, 255, 0.25); 
}

/* Заголовки */
h1, h2, h3, h4, h5 {
  color: #ffffff; 
}

/* --- НОВЫЕ СТИЛИ ДЛЯ ПОЗИЦИЙ --- */
.item-details {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
  margin-top: 0.5rem; /* Отступ сверху */
}

.item-details div {
  display: flex;
  align-items: center;
  white-space: nowrap;
}

/* На мобильных устройствах */
@media (max-width: 768px) {
  .item-details {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
  }

  .item-details div {
    width: 100%; /* Занимает всю ширину */
    justify-content: flex-start; /* Выравнивание по левому краю */
    gap: 0.25rem; /* Отступ между текстом и значением */
  }

  .item-details div::before {
    content: attr(data-label) ": "; /* Добавляем подпись (например, "Кол-во: ") */
    white-space: nowrap;
  }

  .item-actions {
    opacity: 1; /* Всегда видно */
    margin-top: 0; /* Убран отступ сверху */
    align-self: flex-start; /* Выравнивание по верхнему краю */
    margin-left: 0; /* Убран отступ слева */
    padding-top: 0.25rem; /* Небольшой отступ сверху */
  }
  .item-actions {
    align-self: center; /* Выравнивание по центру */
    margin-top: 0.5rem; /* Отступ сверху */
  }
}

/* Для ширины экрана меньше 1000px */
@media (max-width: 1000px) {
  /* Контейнер карточки делаем вертикальным */
  .item-card .d-flex.justify-content-between {
    flex-direction: column;
    gap: 0.5rem;
  }

  /* Основной блок с полями товара */
  .item-card .flex-grow-1 {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  /* Каждый блок Кол-во / Цена / Сумма на отдельной строке */
  .item-card .flex-grow-1 div {
    display: flex;
    flex-direction: row; /* подпись + input/спан в одной строке */
    align-items: center;
    justify-content: flex-start;
    gap: 0.5rem;
    width: 100%;
  }

  /* Inputs и span занимают только нужное место */
  .item-card .flex-grow-1 div input,
  .item-card .flex-grow-1 div .item-total {
    width: auto;
    flex: none;
  }

  /* Кнопки действий под блоком */
  .item-actions {
    margin-top: 0.5rem;
    width: 100%;
    display: flex;
    justify-content: flex-start;
  }
}
</style>
</head>
<body>
  <%- include('partials/navbar') %>
  <div class="container mt-4">
    <h1><%= order ? `Заказ #${order.id}` : 'Новый Заказ' %></h1>

    <form id="orderForm" action="<%= order ? `/orders/${order.id}` : '/orders' %>" method="POST">
      <% if(order) { %><input type="hidden" name="_method" value="PUT"><% } %>

      <div class="row">
        <div class="col-md-6">
          <label class="form-label mt-2">Имя клиента</label>
          <input type="text" class="form-control" name="clientName" required value="<%= order?.client_name || '' %>">

          <label class="form-label mt-2">Телефон</label>
          <input type="text" class="form-control" name="clientPhone" value="<%= order?.client_phone || '' %>">

          <label class="form-label mt-2">Город получателя</label>
          <input type="text" class="form-control" name="destinationCity" required value="<%= order?.destination_city || '' %>">

          <label class="form-label mt-2">Дата заказа</label>
          <input type="date" class="form-control" name="orderDate"
            value="<%= order ? new Date(order.order_date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0] %>">

          <label class="form-label mt-2">Доставка Китай-Москва</label>
          <input type="number" step="0.01" class="form-control" id="ship1" name="shippingCostChinaMoscow" value="<%= order?.shipping_cost_china_moscow || 0 %>">

          <label class="form-label mt-2">Доставка Москва-Город</label>
          <input type="number" step="0.01" class="form-control" id="ship2" name="shippingCostMoscowDestination" value="<%= order?.shipping_cost_moscow_destination || 0 %>">
        </div>

        <div class="col-md-6">
          <label class="form-label mt-2">Посредник Китай-Москва</label>
          <input type="text" class="form-control" name="intermediaryChinaMoscow" value="<%= order?.intermediary_china_moscow || '' %>">

          <label class="form-label mt-2">Трек-номер Китай-Москва</label>
          <input type="text" class="form-control" name="trackingNumberChinaMoscow" value="<%= order?.tracking_number_china_moscow || '' %>">

          <label class="form-label mt-2">Посредник Москва-Город</label>
          <input type="text" class="form-control" name="intermediaryMoscowDestination" value="<%= order?.intermediary_moscow_destination || '' %>">

          <label class="form-label mt-2">Трек-номер Москва-Город</label>
          <input type="text" class="form-control" name="trackingNumberMoscowDestination" value="<%= order?.tracking_number_moscow_destination || '' %>">
        </div>
      </div>

      <button class="btn btn-primary mt-3"><%= order ? 'Сохранить изменения' : 'Создать заказ' %></button>
    </form>

    <% if(order) { %>
      <button class="btn btn-outline-danger mt-3" id="deleteOrderBtn">Удалить заказ</button>
      <a href="/orders" class="btn btn-secondary mt-3">Назад</a>

      <hr>
     <h2>Товары</h2>
<div id="itemsContainer">
  <% if(order.items?.length) { order.items.forEach(item => { %>
    <div class="card item-card mb-2" data-id="<%= item.id %>">
      <div class="d-flex justify-content-between align-items-start"> <!-- align-items-start -->
        <div class="flex-grow-1">
          <input type="text" class="form-control form-control-sm mb-2 product-name-input" 
                 value="<%= item.product_name %>" 
                 data-field="product_name" 
                 data-item-id="<%= item.id %>" 
                 placeholder="Название товара">
          <div>
            Кол-во:
            <input type="number" class="form-control form-control-sm d-inline w-auto me-2 qty-input" 
                   style="width: 80px;" 
                   value="<%= item.quantity %>" 
                   min="1" 
                   data-field="quantity" 
                   data-item-id="<%= item.id %>" 
                   placeholder="1">
            Цена:
            <input type="number" class="form-control form-control-sm d-inline w-auto me-2 price-input" 
                   style="width: 100px;" 
                   value="<%= (+item.price).toFixed(2) %>" 
                   step="0.01" 
                   min="0" 
                   data-field="price" 
                   data-item-id="<%= item.id %>" 
                   placeholder="0.00">
            Сумма: <span class="item-total"><%= (+item.item_total).toFixed(2) %></span>
          </div>
        </div>
        <div class="item-actions">
          <button class="btn btn-sm btn-outline-danger delete-item">×</button>
        </div>
      </div>
    </div>
  <% }) } else { %>
    <p>Нет товаров</p>
  <% } %>
</div>

      <button class="btn btn-outline-light mt-2" id="addItemBtn">+ Добавить позицию</button>
      <div class="d-flex justify-content-end mt-3">
        <h5>Итого: <span id="totalAmountDisplay"><%= (+order.total_amount).toFixed(2) %></span></h5>
      </div>
    <% } %>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const orderId = <%= order ? order.id : 'null' %>;

    // Удаление заказа
    const delOrderBtn = document.getElementById('deleteOrderBtn');
    if (delOrderBtn) {
      delOrderBtn.onclick = async () => {
        if (!confirm("Удалить заказ?")) return;
        const res = await fetch(`/orders/${orderId}?_method=DELETE`, { method: "POST" });
        if (res.ok) location.href = "/orders";
        else alert("Ошибка удаления");
      };
    }

    // --- НОВАЯ ЛОГИКА: Обработка изменений в input'ах ---
    // Обработчик потери фокуса для всех input'ов
    document.body.addEventListener('blur', async (e) => {
      if (!e.target.matches('input[data-field][data-item-id]')) return;

      const input = e.target;
      const field = input.dataset.field;
      const itemId = input.dataset.itemId;
      const newValue = input.value.trim();

      // Валидация
      if (field === 'quantity' || field === 'price') {
        const numValue = parseFloat(newValue);
        if (isNaN(numValue) || (field === 'quantity' && numValue < 1) || (field === 'price' && numValue < 0)) {
          alert(`Некорректное значение для ${field === 'quantity' ? 'количества' : 'цены'}`);
          input.focus();
          return;
        }
      }

      if (field === 'product_name' && !newValue) {
        alert('Название товара не может быть пустым');
        input.focus();
        return;
      }

      // Отправляем обновление
      const response = await updateItem(itemId, field, newValue);
      if(response && response.success) {
        // Обновляем сумму, если изменили кол-во или цену
        if(field === 'quantity' || field === 'price') {
          const card = input.closest("[data-id]");
          if(response.item) {
            const serverUpdatedTotal = parseFloat(response.item.item_total).toFixed(2);
            card.querySelector('.item-total').textContent = serverUpdatedTotal;
          }
          // Обновляем общую сумму заказа
          if(response.totalAmount !== undefined) {
            document.getElementById('totalAmountDisplay').textContent = parseFloat(response.totalAmount).toFixed(2);
          } else {
            updateTotals(); // Резервный пересчёт на клиенте
          }
        } else {
          // Для других полей (например, названия) обновляем общую сумму
          if(response.totalAmount !== undefined) {
            document.getElementById('totalAmountDisplay').textContent = parseFloat(response.totalAmount).toFixed(2);
          } else {
            updateTotals(); // Резервный пересчёт на клиенте
          }
        }
      } else {
        alert("Ошибка обновления");
        // Восстанавливаем старое значение
        const originalValue = input.getAttribute('data-original-value');
        if(originalValue) input.value = originalValue;
      }
    }, true);

    // Сохраняем оригинальное значение при фокусе
    document.body.addEventListener('focus', (e) => {
      if (e.target.matches('input[data-field][data-item-id]')) {
        e.target.setAttribute('data-original-value', e.target.value);
      }
    }, true);

    // Обработка Enter в input'ах
    document.body.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.matches('input[data-field][data-item-id]')) {
        e.target.blur(); // Триггерим обновление
      }
    });

    // --- НОВАЯ ЛОГИКА: Пересчёт суммы при вводе ---
    document.body.addEventListener('input', (e) => {
      if (!e.target.matches('.qty-input, .price-input')) return;

      const input = e.target;
      const card = input.closest("[data-id]");

      const qtyInput = card.querySelector('.qty-input');
      const priceInput = card.querySelector('.price-input');
      const totalSpan = card.querySelector('.item-total');

      const qty = parseFloat(qtyInput.value) || 0;
      const price = parseFloat(priceInput.value) || 0;
      const total = qty * price;

      totalSpan.textContent = total.toFixed(2);

      // --- НОВОЕ: Обновление общей суммы заказа при вводе ---
      updateTotals();
    });

    // --- НОВАЯ ЛОГИКА: Добавление товара через строку ---
    const addBtn = document.getElementById("addItemBtn");
    if (addBtn) {
       addBtn.onclick = () => {
         // Создаём карточку с полями ввода
         const newCard = document.createElement("div");
         newCard.className = "card item-card p-3 mb-2";
         newCard.innerHTML = `
           <div class="d-flex justify-content-between align-items-start">
             <div class="flex-grow-1">
               <input type="text" class="form-control form-control-sm mb-2" placeholder="Название товара" data-field="product_name">
               <div>
                 Кол-во:
                 <input type="number" class="form-control form-control-sm d-inline w-auto me-2 qty-input" style="width: 80px;" placeholder="1" value="1" min="1" data-field="quantity">
                 Цена:
                 <input type="number" class="form-control form-control-sm d-inline w-auto me-2 price-input" style="width: 100px;" placeholder="0.00" value="0.00" step="0.01" min="0" data-field="price">
                 Сумма: <span class="item-total">0.00</span>
               </div>
             </div>
             <div class="item-actions">
               <button class="btn btn-sm btn-success save-new-item">✓</button>
               <button class="btn btn-sm btn-outline-danger cancel-new-item ms-1">×</button>
             </div>
           </div>
         `;
         // Вставляем карточку перед кнопкой "Добавить позицию"
         addBtn.parentNode.insertBefore(newCard, addBtn);

         // Находим элементы в новой карточке
         const nameInput = newCard.querySelector('input[data-field="product_name"]');
         const qtyInput = newCard.querySelector('input[data-field="quantity"]');
         const priceInput = newCard.querySelector('input[data-field="price"]');
         const totalSpan = newCard.querySelector('.item-total');
         const saveBtn = newCard.querySelector('.save-new-item');
         const cancelBtn = newCard.querySelector('.cancel-new-item');

         // Фокус на поле названия
         nameInput.focus();

         // Обновление суммы при изменении кол-ва или цены
         const recalculateTotal = () => {
           const qty = parseFloat(qtyInput.value) || 0;
           const price = parseFloat(priceInput.value) || 0;
           totalSpan.textContent = (qty * price).toFixed(2);
           // --- НОВОЕ: Обновление общей суммы заказа при вводе в новой карточке ---
           updateTotals();
         };
         qtyInput.addEventListener('input', recalculateTotal);
         priceInput.addEventListener('input', recalculateTotal);

         // Кнопка сохранить
         saveBtn.onclick = async () => {
           const name = nameInput.value.trim();
           const qty = parseInt(qtyInput.value, 10);
           const price = parseFloat(priceInput.value);

           if (!name) {
             alert("Введите название товара.");
             nameInput.focus();
             return;
           }
           if (isNaN(qty) || qty <= 0) {
             alert("Количество должно быть положительным числом.");
             qtyInput.focus();
             return;
           }
           if (isNaN(price) || price < 0) {
             alert("Цена должна быть неотрицательным числом.");
             priceInput.focus();
             return;
           }

           try {
             const res = await fetch(`/orders/${orderId}/items`, {
               method: "POST",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify({ product_name: name, quantity: qty, price: price })
             });

             if (res.ok) {
               location.reload(); // Перезагружаем, чтобы отобразить новый товар с ID и обновить итог
             } else {
               alert("Ошибка при добавлении товара");
             }
           } catch (error) {
             console.error('Error:', error);
             alert("Ошибка при добавлении товара");
           }
         };

         // Кнопка отмены
         cancelBtn.onclick = () => {
           newCard.remove();
         };

         // Enter в поле названия = сохранить
         nameInput.addEventListener('keypress', (e) => {
           if (e.key === 'Enter') saveBtn.click();
         });
       };
    }

    // Удаление товара
    document.body.addEventListener("click", async e => {
      if (!e.target.classList.contains("delete-item")) return;
      const card = e.target.closest("[data-id]");
      const itemId = card.dataset.id;
      if (!confirm("Удалить позицию?")) return;
      const res = await fetch(`/orders/${orderId}/items/${itemId}?_method=DELETE`, { method: "POST" });
      if (res.ok) {
        card.remove();
        updateTotals();
      } else {
        alert("Ошибка удаления");
      }
    });

    async function updateItem(id, field, value) {
      try {
        const res = await fetch(`/orders/${orderId}/items/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ [field]: value })
        });
        if (!res.ok) throw new Error("Ошибка HTTP");
        const response = await res.json();
        return response;
      } catch (e) {
        alert("Ошибка обновления товара");
        console.error(e);
        return null;
      }
    }

    function updateTotals() {
      const totals = [...document.querySelectorAll(".item-total")];
      const sum = totals.reduce((acc, t) => acc + (+t.textContent || 0), 0);
      document.getElementById('totalAmountDisplay').textContent = sum.toFixed(2);
    }
  });
</script>
</body>
</html>