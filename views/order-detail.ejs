<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= order ? `Заказ #${order.id}` : 'Новый Заказ' %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #212529; color: #fff; }
    .item-card {
      background-color: #2d3238;
      border-radius: .5rem;
      border: 1px solid rgba(255,255,255,.1);
      transition: .2s;
    }
    .item-card:hover { box-shadow: 0 0 10px rgba(0,0,0,.4); }
    .editable-field { cursor: pointer; border-bottom: 1px dashed transparent; }
    .editable-field:hover { border-bottom: 1px dashed #86b7fe; }
    .item-actions { opacity: 0; transition: .2s; }
    .item-card:hover .item-actions { opacity: 1; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>
  <div class="container mt-4">
    <h1><%= order ? `Заказ #${order.id}` : 'Новый Заказ' %></h1>

    <form id="orderForm" action="<%= order ? `/orders/${order.id}` : '/orders' %>" method="POST">
      <% if(order) { %><input type="hidden" name="_method" value="PUT"><% } %>

      <div class="row">
        <div class="col-md-6">
          <label class="form-label mt-2">Имя клиента</label>
          <input type="text" class="form-control" name="clientName" required value="<%= order?.client_name || '' %>">

          <label class="form-label mt-2">Телефон</label>
          <input type="text" class="form-control" name="clientPhone" value="<%= order?.client_phone || '' %>">

          <label class="form-label mt-2">Город получателя</label>
          <input type="text" class="form-control" name="destinationCity" required value="<%= order?.destination_city || '' %>">

          <label class="form-label mt-2">Дата заказа</label>
          <input type="date" class="form-control" name="orderDate"
            value="<%= order ? new Date(order.order_date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0] %>">

          <label class="form-label mt-2">Доставка Китай-Москва</label>
          <input type="number" step="0.01" class="form-control" id="ship1" name="shippingCostChinaMoscow" value="<%= order?.shipping_cost_china_moscow || 0 %>">

          <label class="form-label mt-2">Доставка Москва-Город</label>
          <input type="number" step="0.01" class="form-control" id="ship2" name="shippingCostMoscowDestination" value="<%= order?.shipping_cost_moscow_destination || 0 %>">
        </div>

        <div class="col-md-6">
          <label class="form-label mt-2">Посредник Китай-Москва</label>
          <input type="text" class="form-control" name="intermediaryChinaMoscow" value="<%= order?.intermediary_china_moscow || '' %>">

          <label class="form-label mt-2">Трек-номер Китай-Москва</label>
          <input type="text" class="form-control" name="trackingNumberChinaMoscow" value="<%= order?.tracking_number_china_moscow || '' %>">

          <label class="form-label mt-2">Посредник Москва-Город</label>
          <input type="text" class="form-control" name="intermediaryMoscowDestination" value="<%= order?.intermediary_moscow_destination || '' %>">

          <label class="form-label mt-2">Трек-номер Москва-Город</label>
          <input type="text" class="form-control" name="trackingNumberMoscowDestination" value="<%= order?.tracking_number_moscow_destination || '' %>">
        </div>
      </div>

      <button class="btn btn-primary mt-3"><%= order ? 'Обновить заказ' : 'Создать заказ' %></button>
    </form>

    <% if(order) { %>
      <button class="btn btn-outline-danger mt-3" id="deleteOrderBtn">Удалить заказ</button>
      <a href="/orders" class="btn btn-secondary mt-3">Назад</a>

      <hr>
      <h2>Товары</h2>
      <div id="itemsContainer">
        <% if(order.items?.length) { order.items.forEach(item => { %>
          <div class="card item-card p-3 mb-2" data-id="<%= item.id %>">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <strong class="editable-field" data-field="product_name"><%= item.product_name %></strong>
                <div class="mt-2">
                  Кол-во:
                  <span class="editable-field" data-field="quantity"><%= item.quantity %></span>,
                  Цена:
                  <span class="editable-field" data-field="price"><%= (+item.price).toFixed(2) %></span>,
                  Сумма: <span class="item-total"><%= (+item.item_total).toFixed(2) %></span>
                </div>
              </div>
              <div class="item-actions">
                <button class="btn btn-sm btn-outline-danger delete-item">×</button>
              </div>
            </div>
          </div>
        <% }) } else { %>
          <p>Нет товаров</p>
        <% } %>
      </div>

      <button class="btn btn-outline-light mt-2" id="addItemBtn">+ Добавить позицию</button>
      <div class="d-flex justify-content-end mt-3">
        <h5>Итого: <span id="totalAmountDisplay"><%= (+order.total_amount).toFixed(2) %></span></h5>
      </div>
    <% } %>
  </div>

  <script>
    // УДАЛЕНО: async function addItem(orderId) { ... }

    document.addEventListener("DOMContentLoaded", () => {
      const orderId = <%= order ? order.id : 'null' %>;

      // Удаление заказа
      const delOrderBtn = document.getElementById('deleteOrderBtn');
      if (delOrderBtn) {
        delOrderBtn.onclick = async () => {
          if (!confirm("Удалить заказ?")) return;
          const res = await fetch(`/orders/${orderId}?_method=DELETE`, { method: "POST" });
          if (res.ok) location.href = "/orders";
          else alert("Ошибка удаления");
        };
      }

      // Inline редактирование
      document.body.addEventListener("click", e => {
        if (!e.target.classList.contains("editable-field")) return;
        const span = e.target;
        const field = span.dataset.field;
        const parent = span.closest("[data-id]");
        const itemId = parent.dataset.id;
        const input = document.createElement("input");
        input.type = (field === "quantity" || field === "price") ? "number" : "text";
        input.value = span.textContent.trim();
        input.className = "form-control form-control-sm d-inline w-auto";
        span.replaceWith(input);
        input.focus();

        // ИСПРАВЛЕНО: обновление item_total на клиенте при изменении quantity или price
        input.addEventListener("blur", async () => {
          const newValue = input.value.trim();
          const response = await updateItem(itemId, field, newValue); // <-- Обновите функцию, чтобы она возвращала ответ
          if(response && response.success) { // <-- Проверяем успешность
            span.textContent = newValue;
            // Обновляем item_total на странице, если обновляли quantity или price
            if(field === 'quantity' || field === 'price') {
                // Получаем текущие значения из DOM или из ответа сервера
                // Используем ответ сервера, если он содержит обновленный элемент
                if(response.item) {
                    // Если сервер возвращает обновленный item, используем его данные
                    const serverUpdatedTotal = parseFloat(response.item.item_total).toFixed(2);
                    span.closest("[data-id]").querySelector('.item-total').textContent = serverUpdatedTotal;
                } else {
                    // Альтернатива: вычисляем на клиенте (менее надёжно, если логика на сервере сложнее)
                    const qtySpan = span.closest("[data-id]").querySelector('[data-field="quantity"]');
                    const priceSpan = span.closest("[data-id]").querySelector('[data-field="price"]');
                    // Используем обновлённое значение, если это поле, или старое значение из DOM
                    const currentQty = field === 'quantity' ? newValue : (qtySpan.textContent || 1);
                    const currentPrice = field === 'price' ? newValue : (priceSpan.textContent || 0);
                    const total = parseFloat(currentQty) * parseFloat(currentPrice);
                    span.closest("[data-id]").querySelector('.item-total').textContent = total.toFixed(2);
                }
            }
            updateTotals(); // <-- Обновляем общую сумму
          } else {
             alert("Ошибка обновления");
          }
          input.replaceWith(span);
        });

        input.addEventListener("keydown", ev => {
          if (ev.key === "Enter") input.blur();
        });
      });

      // Добавление товара
      const addBtn = document.getElementById("addItemBtn");
      if (addBtn) {
         addBtn.onclick = () => {
           const name = prompt("Название товара:");
           if (!name) return;
           const qty = parseInt(prompt("Количество:", "1")) || 1;
           const price = parseFloat(prompt("Цена:", "0")) || 0;

           // Проверки на числа можно улучшить, но для простоты оставим так
           if (isNaN(qty) || qty <= 0) {
             alert("Количество должно быть положительным числом.");
             return;
           }
           if (isNaN(price) || price < 0) {
             alert("Цена должна быть неотрицательным числом.");
             return;
           }

           fetch(`/orders/${orderId}/items`, {
             method: "POST",
             headers: { "Content-Type": "application/json" },
             body: JSON.stringify({ product_name: name, quantity: qty, price: price })
           })
           .then(response => {
             if(response.ok) {
               location.reload(); // Перезагружаем для отображения нового товара и обновления итога
             } else {
               alert("Ошибка при добавлении товара");
             }
           })
           .catch(error => {
             console.error('Error:', error);
             alert("Ошибка при добавлении товара");
           });
         };
      }

      // Удаление товара
      document.body.addEventListener("click", async e => {
        if (!e.target.classList.contains("delete-item")) return;
        const card = e.target.closest("[data-id]");
        const itemId = card.dataset.id;
        if (!confirm("Удалить позицию?")) return;
        const res = await fetch(`/orders/${orderId}/items/${itemId}?_method=DELETE`, { method: "POST" });
        if (res.ok) {
          card.remove();
          updateTotals(); // Обновляем итог после удаления
        } else {
          alert("Ошибка удаления");
        }
      });

      async function updateItem(id, field, value) {
        try {
          const res = await fetch(`/orders/${orderId}/items/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ [field]: value })
          });
          if (!res.ok) throw new Error("Ошибка HTTP");
          const response = await res.json();
          return response; // Возвращаем ответ сервера
        } catch (e) {
          alert("Ошибка обновления товара");
          console.error(e);
          return null;
        }
      }

      function updateTotals() {
        const totals = [...document.querySelectorAll(".item-total")];
        const sum = totals.reduce((acc, t) => acc + (+t.textContent || 0), 0);
        document.getElementById('totalAmountDisplay').textContent = sum.toFixed(2);
      }
    });
</script>
</body>
</html>